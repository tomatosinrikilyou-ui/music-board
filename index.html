<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ã‚¤ãƒ„ãƒ¡ãƒ³SNSãƒ»æ¥µãƒãƒ£ãƒƒãƒˆ</title>
    <style>
        :root { --p-blue: #007aff; --p-green: #34c759; --bg: #000; --panel: rgba(28, 28, 30, 0.95); }
        body { margin: 0; background: var(--bg); color: #eee; font-family: -apple-system, sans-serif; height: 100vh; display: flex; flex-direction: column; overflow: hidden; background-size: cover; background-position: center; transition: 0.5s; }
        
        header { padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; backdrop-filter: blur(20px); background: rgba(0,0,0,0.6); z-index: 1000; border-bottom: 0.5px solid #333; height: 50px; }
        #room-display { font-size: 13px; font-weight: bold; background: rgba(255,255,255,0.1); padding: 6px 15px; border-radius: 20px; cursor: pointer; color: var(--p-green); }

        #chat-container { flex-grow: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 18px; scroll-behavior: smooth; }
        .msg { display: flex; flex-direction: column; max-width: 80%; position: relative; }
        .msg.me { align-self: flex-end; }
        .msg.other { align-self: flex-start; }

        .user-label { font-size: 10px; opacity: 0.7; margin-bottom: 4px; display: flex; align-items: center; gap: 6px; }
        .u-icon { width: 24px; height: 24px; border-radius: 50%; object-fit: cover; border: 1px solid rgba(255,255,255,0.2); }

        .msg-bubble { padding: 10px 14px; border-radius: 18px; font-size: 14px; line-height: 1.4; word-break: break-all; box-shadow: 0 2px 8px rgba(0,0,0,0.3); cursor: pointer; }
        .msg.me .msg-bubble { border-bottom-right-radius: 4px; }
        .msg.other .msg-bubble { border-bottom-left-radius: 4px; }

        /* å¼•ç”¨è¡¨ç¤ºã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .quote-info { background: rgba(0,0,0,0.3); padding: 5px 8px; border-radius: 8px; margin-bottom: 5px; font-size: 11px; border-left: 2px solid var(--p-green); opacity: 0.8; }
        #quote-preview { display: none; background: #1c1c1e; padding: 8px 15px; font-size: 12px; border-top: 1px solid #333; justify-content: space-between; align-items: center; color: var(--p-green); }

        .msg-footer { display: flex; align-items: center; gap: 5px; font-size: 9px; opacity: 0.5; margin-top: 4px; }
        .msg.me .msg-footer { justify-content: flex-end; }
        .time-stamp { font-family: monospace; }
        .dm-badge { color: #ff9500; font-weight: bold; margin-right: 5px; }

        #dm-indicator { display: none; background: #ff9500; color: white; text-align: center; font-size: 11px; padding: 5px; font-weight: bold; }

        .input-area { background: var(--panel); padding: 10px 10px 30px; border-top: 0.5px solid #333; }
        .input-row { display: flex; align-items: center; gap: 10px; max-width: 800px; margin: 0 auto; }
        .btn-circle { width: 38px; height: 38px; border-radius: 50%; border: none; background: #2c2c2e; color: white; font-size: 18px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .text-in { flex-grow: 1; background: #1c1c1e; border: 1px solid #3a3a3c; border-radius: 20px; padding: 10px 15px; color: white; outline: none; font-size: 15px; }
        
        #rec-display { display: none; background: #ff3b30; color: white; text-align: center; font-size: 11px; padding: 4px; border-radius: 10px; margin-bottom: 5px; }

        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 5000; display: none; justify-content: center; align-items: center; backdrop-filter: blur(10px); }
        .m-content { background: #1c1c1e; width: 85%; max-width: 350px; border-radius: 25px; padding: 25px; border: 1px solid #333; }
        .tool-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; }
        .tool-item { aspect-ratio: 1; background: #2c2c2e; border-radius: 15px; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 12px; cursor: pointer; border: 1px solid #444; }

        #side-menu { position: fixed; right: -280px; top: 0; width: 280px; height: 100%; background: #1c1c1e; transition: 0.3s; z-index: 4000; padding: 20px; box-sizing: border-box; border-left: 1px solid #333; }
        #side-menu.open { right: 0; }
        .online-user { padding: 12px; border-radius: 12px; background: #2c2c2e; margin-bottom: 8px; cursor: pointer; display: flex; align-items: center; gap: 10px; font-size: 14px; }
    </style>
</head>
<body id="body">

    <header>
        <button class="btn-circle" style="font-size:14px;" onclick="showModal('m-cfg')">âš™ï¸</button>
        <div id="room-display" onclick="toBoard()">ğŸ¨ æãè¾¼ã¿ãƒœãƒ¼ãƒ‰ã¸</div>
        <button class="btn-circle" onclick="toggleMenu()">â‰¡</button>
    </header>

    <div id="dm-indicator">ğŸ”’ <span id="dm-target-name"></span> ã•ã‚“ã«DMé€ä¿¡ä¸­... <span onclick="cancelDM()" style="text-decoration:underline; cursor:pointer; margin-left:10px;">[è§£é™¤]</span></div>

    <div id="chat-container"></div>

    <div id="quote-preview">
        <span id="quote-msg"></span>
        <span onclick="cancelQuote()" style="cursor:pointer; color:#999;">[Ã—]</span>
    </div>

    <div class="input-area">
        <div id="rec-display">â— éŒ²éŸ³ä¸­... (ã‚‚ã†ä¸€åº¦ãƒã‚¤ã‚¯ã‚’æŠ¼ã—ã¦é€ä¿¡)</div>
        <div class="input-row">
            <button class="btn-circle" onclick="showModal('m-tools')">ï¼‹</button>
            <input type="text" id="msg-in" class="text-in" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸..." onkeydown="if(event.key==='Enter') send()">
            <button id="rec-btn" class="btn-circle" onclick="toggleRec()">ğŸ¤</button>
            <button onclick="send()" style="background:none; border:none; color:var(--p-blue); font-size:28px; cursor:pointer;">ğŸš€</button>
        </div>
    </div>

    <div id="m-tools" class="modal" onclick="closeModal()">
        <div class="m-content" onclick="event.stopPropagation()">
            <div class="tool-grid">
                <div class="tool-item" onclick="document.getElementById('img-in').click()">ğŸ–¼ï¸<br>ç”»åƒ</div>
                <div class="tool-item" onclick="sendEmoji('ğŸ”¥')">ğŸ”¥<br>ã‚¢ãƒ„ã„</div>
                <div class="tool-item" onclick="sendEmoji('ğŸ’–')">ğŸ’–<br>ã™ã</div>
                <div class="tool-item" onclick="showModal('m-room')">ğŸ <br>éƒ¨å±‹</div>
            </div>
            <input type="file" id="img-in" hidden accept="image/*" onchange="upImg(this)">
        </div>
    </div>

    <div id="m-cfg" class="modal" onclick="closeModal()">
        <div class="m-content" onclick="event.stopPropagation()">
            <h3 style="margin-top:0">å€‹äººè¨­å®š</h3>
            <label style="font-size:12px;">ã‚¢ã‚¤ã‚³ãƒ³</label><input type="file" onchange="upIcon(this)" style="margin-bottom:10px; width:100%;">
            <label style="font-size:12px;">èƒŒæ™¯ç”»åƒ</label><input type="file" onchange="upBg(this)" style="margin-bottom:10px; width:100%;">
            <div style="display:flex; gap:10px; margin-bottom:15px;">
                <div style="flex:1;"><label style="font-size:10px;">å¹ãå‡ºã—</label><input type="color" id="cfg-bc" value="#007aff" style="width:100%; height:30px; border:none; background:none;"></div>
                <div style="flex:1;"><label style="font-size:10px;">æ–‡å­—è‰²</label><input type="color" id="cfg-tc" value="#ffffff" style="width:100%; height:30px; border:none; background:none;"></div>
            </div>
            <button onclick="saveCfg()" style="width:100%; padding:12px; border-radius:12px; background:var(--p-blue); color:white; border:none; font-weight:bold;">è¨­å®šã‚’ä¿å­˜</button>
        </div>
    </div>

    <div id="m-room" class="modal" onclick="closeModal()">
        <div class="m-content" onclick="event.stopPropagation()">
            <h3>éƒ¨å±‹ã‚’ç§»å‹•ã™ã‚‹</h3>
            <input type="text" id="room-pass" placeholder="åˆè¨€è‘‰ã‚’å…¥åŠ›" style="width:100%; padding:12px; background:#2c2c2e; border:none; color:white; border-radius:10px; box-sizing:border-box;">
            <button onclick="location.href='?r='+document.getElementById('room-pass').value" style="width:100%; margin-top:10px; padding:12px; border-radius:10px; background:var(--p-green); border:none; color:white; font-weight:bold;">ç§»å‹•</button>
        </div>
    </div>

    <div id="side-menu">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h3 style="margin:0">Online</h3>
            <div style="font-size:24px; cursor:pointer;" onclick="toggleMenu()">Ã—</div>
        </div>
        <div id="online-list"></div>
        <p style="font-size:10px; opacity:0.5; margin-top:20px;">åå‰ã‚’ã‚¿ãƒƒãƒ—ã—ã¦DMã‚’é–‹å§‹</p>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, limit, doc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyAeOZ38w4uNQbSaMrv8uxRvlkxrHDfyrSM", authDomain: "itumen-69ddb.firebaseapp.com", projectId: "itumen-69ddb", storageBucket: "itumen-69ddb.firebasestorage.app", messagingSenderId: "381294255289", appId: "1:381294255289:web:04637d25dd7cbbde648f68" };
        const app = initializeApp(firebaseConfig); const db = getFirestore(app);

        const params = new URLSearchParams(window.location.search);
        let roomID = params.get('r') || "lobby", myName = localStorage.getItem('myName') || prompt("è¡¨ç¤ºåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„") || "ã‚²ã‚¹ãƒˆ";
        localStorage.setItem('myName', myName);

        let myIcon = localStorage.getItem('myIcon') || "", myBC = localStorage.getItem('myBC') || "#007aff", myTC = localStorage.getItem('myTC') || "#ffffff";
        let targetDM = null, mediaRecorder, audioChunks = [];
        let quoting = null; // å¼•ç”¨ãƒ‡ãƒ¼ã‚¿ä¿æŒç”¨

        window.showModal = id => { closeModal(); document.getElementById(id).style.display='flex'; };
        window.closeModal = () => document.querySelectorAll('.modal').forEach(m=>m.style.display='none');
        window.toggleMenu = () => document.getElementById('side-menu').classList.toggle('open');

        // ãƒœãƒ¼ãƒ‰ã¸ã®é€£æºãƒ­ã‚¸ãƒƒã‚¯
        window.toBoard = () => {
            location.href = 'board.html?r=' + roomID;
        };

        // å¼•ç”¨ã‚»ãƒƒãƒˆãƒ­ã‚¸ãƒƒã‚¯
        window.setQuote = (name, text) => {
            quoting = { name, text: text.substring(0, 20) + (text.length > 20 ? "..." : "") };
            document.getElementById('quote-preview').style.display = 'flex';
            document.getElementById('quote-msg').innerText = "å¼•ç”¨: " + name + "ã€Œ" + quoting.text + "ã€";
            document.getElementById('msg-in').focus();
        };
        window.cancelQuote = () => { quoting = null; document.getElementById('quote-preview').style.display = 'none'; };

        // DMè¨­å®š
        window.startDM = (name) => {
            if(name === myName) return;
            targetDM = name;
            document.getElementById('dm-indicator').style.display = 'block';
            document.getElementById('dm-target-name').innerText = name;
            toggleMenu();
        };
        window.cancelDM = () => { targetDM = null; document.getElementById('dm-indicator').style.display = 'none'; };

        // å€‹äººè¨­å®š
        window.saveCfg = () => {
            myBC = document.getElementById('cfg-bc').value; myTC = document.getElementById('cfg-tc').value;
            localStorage.setItem('myBC', myBC); localStorage.setItem('myTC', myTC); closeModal();
        };
        window.upIcon = el => { const r=new FileReader(); r.onload=()=>{ myIcon=r.result; localStorage.setItem('myIcon',r.result); }; r.readAsDataURL(el.files[0]); };
        window.upBg = el => { const r=new FileReader(); r.onload=()=>{ document.body.style.backgroundImage=`url(${r.result})`; }; r.readAsDataURL(el.files[0]); };

        // é€ä¿¡ï¼ˆå¼•ç”¨ãƒ‡ãƒ¼ã‚¿ã‚’å«ã‚ã‚‹ã‚ˆã†ä¿®æ­£ï¼‰
        window.send = async (ex = {}) => {
            const val = document.getElementById('msg-in').value.trim(); if(!val && !ex.img && !ex.audio) return;
            await addDoc(collection(db, "chats_"+roomID), { 
                name: myName, icon: myIcon, text: val, bc: myBC, tc: myTC, 
                time: Date.now(), to: targetDM, quote: quoting, ...ex 
            });
            document.getElementById('msg-in').value = "";
            cancelQuote();
        };

        window.sendEmoji = (e) => { send({ text: e }); closeModal(); };
        window.upImg = el => { const r=new FileReader(); r.onload=()=>send({img:r.result}); r.readAsDataURL(el.files[0]); closeModal(); };

        // éŒ²éŸ³
        window.toggleRec = async () => {
            if(!mediaRecorder || mediaRecorder.state === "inactive") {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream); audioChunks = [];
                mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
                mediaRecorder.onstop = async () => {
                    const blob = new Blob(audioChunks, { type: 'audio/ogg; codecs=opus' });
                    const r = new FileReader(); r.onload = () => send({ audio: r.result });
                    r.readAsDataURL(blob);
                };
                mediaRecorder.start(); document.getElementById('rec-display').style.display='block';
            } else {
                mediaRecorder.stop(); document.getElementById('rec-display').style.display='none';
            }
        };

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡ï¼ˆå¼•ç”¨è¡¨ç¤ºã‚’è¿½åŠ ï¼‰
        onSnapshot(query(collection(db, "chats_"+roomID), orderBy("time", "asc"), limit(50)), snap => {
            const cont = document.getElementById('chat-container'); cont.innerHTML = "";
            snap.forEach(d => {
                const data = d.data();
                const isDM = !!data.to;
                if(isDM && data.to !== myName && data.name !== myName) return;

                const isMe = data.name === myName;
                const date = new Date(data.time);
                const timeStr = date.getHours().toString().padStart(2,'0')+":"+date.getMinutes().toString().padStart(2,'0');

                const div = document.createElement('div'); div.className = `msg ${isMe?'me':'other'}`;
                div.innerHTML = `
                    <div class="user-label">${isMe?'':`<img src="${data.icon||''}" class="u-icon">`} ${data.name}</div>
                    <div class="msg-bubble" style="background:${data.bc}; color:${data.tc}" onclick="setQuote('${data.name}', '${data.text || (data.img ? '[ç”»åƒ]' : '[éŸ³å£°]')}')">
                        ${data.quote ? `<div class="quote-info">å¼•ç”¨: ${data.quote.name}<br>${data.quote.text}</div>` : ''}
                        ${isDM ? '<span class="dm-badge">ğŸ”’DM</span>' : ''}
                        ${data.img ? `<img src="${data.img}" style="max-width:100%; border-radius:10px;"><br>` : ''}
                        ${data.audio ? `<audio src="${data.audio}" controls style="width:180px; height:35px;"></audio><br>` : ''}
                        ${data.text || ''}
                    </div>
                    <div class="msg-footer">
                        <span class="time-stamp">${timeStr}</span>
                        ${isMe ? '<span>æ—¢èª­</span>' : ''}
                    </div>
                `;
                cont.appendChild(div);
            });
            cont.scrollTop = cont.scrollHeight;
        });

        // ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ç®¡ç†
        const updatePresence = () => setDoc(doc(db, "pres_"+roomID, myName), { name: myName, last: Date.now() });
        setInterval(updatePresence, 5000);
        onSnapshot(collection(db, "pres_"+roomID), snap => {
            const list = document.getElementById('online-list'); list.innerHTML = "";
            snap.forEach(d => {
                const data = d.data();
                if(Date.now() - data.last < 10000) {
                    const item = document.createElement('div'); item.className = "online-user";
                    item.innerHTML = `ğŸ‘¤ ${data.name} ${data.name===myName?'(è‡ªåˆ†)':''}`;
                    item.onclick = () => startDM(data.name);
                    list.appendChild(item);
                }
            });
        });
    </script>
</body>
</html>
